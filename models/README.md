# Embedding models

This folder has the script and tools to create cell embeddings. Currently, the following models are supported:

* [CellPainting-CNN](https://www.nature.com/articles/s41467-024-45999-1)
* [Dino4Cells](https://www.biorxiv.org/content/10.1101/2023.06.16.545359v1)

The output is consolidated into a single csv, tsv or HDF5 file per plate.

## How to use

The script `run_model.py` takes the following arguments:

* model name, either dino4cells or cpcnn
* model path, the path to the file with model weights
* plate path, a folder on the local file system containing the images of one plate
* channel names, the names of channels to pass to the model, e.g., DNA,RNA,ER,AGP,Mito
* channel substrings, substrings in the filename to identify each channel, e.g., -ch5,-ch3,-ch1,-ch4,-ch1
* centers path, the path to the tsv file generated by cellpose
* number of workers, the number workers for Torch Dataloader
* output file, filename ending in .csv, .tsv, or .h5
* inspection file (optional, e.g., crops.png), if supplied, the script writes cropped cell images to this file for manual inspection


The model path should point to [DINO_cell_painting_base_checkpoint.pth](https://zenodo.org/records/8061428) (dino4cells) or [Cell_Painting_CNN_v1.hdf5](https://zenodo.org/records/7114558) (CP-CNN).

The script uses a Torch dataloader to launch background processes for reading images and creating cell crops.


## Output format

Depending on the output filename, the output file will be csv, tsv or HDF5. For csv or tsv output, there will be one line per cell containing the filename, i,j coordinates of cell centers, and the embedding:

```
file    i    j    embedding
r01c01f01p01-ch5sk1fk1fl1.jxl	2	51	['1.236e+00', '2.663e+00', .... ]
r01c01f01p01-ch5sk1fk1fl1.jxl	8	154	['1.539e+00', '2.860e+00', .... ]
```

For HDF5 output, under meta\filename is a list of filenames. Under dino4cells or cpcnn is a matrix where each cell is one row, the first column corresponds to the filename index, the second and third column are the i/j coordinates, and the remaining columns are the embedding.
